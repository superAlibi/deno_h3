name: Deploy Deno H3 Application

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'éƒ¨ç½²ç¯å¢ƒ'
        required: true
        default: 'latest'
        type: choice
        options:
          - latest
          - staging
      tag:
        description: 'è¦éƒ¨ç½²çš„é•œåƒæ ‡ç­¾ (latest, sha-xxx, åˆ†æ”¯å)'
        required: true
        default: 'latest'
        type: string

env:
  REGISTRY: dr.lucardo.website:4443
  IMAGE_NAME: deno-h3

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    
    steps:
      - name: éƒ¨ç½²åˆ°æœåŠ¡å™¨
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            set -e
            IMAGE=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ inputs.tag }}
            CONTAINER_NAME=deno-h3-${{ inputs.environment }}
            PORT=${{ inputs.environment == 'latest' && '5020' || '5021' }}
            
            echo "ğŸ¦• å¼€å§‹éƒ¨ç½² Deno H3 åº”ç”¨"
            echo "ç¯å¢ƒ: ${{ inputs.environment }}"
            echo "ä½¿ç”¨é•œåƒ: $IMAGE"
            
            # ç™»å½•åˆ° registry
            podman login -u ${{ secrets.DOCKER_USERNAME }} -p ${{ secrets.DOCKER_PASSWORD }} ${{ env.REGISTRY }}
            
            # æ‹‰å–é•œåƒ
            echo "ğŸ“¦ æ‹‰å–é•œåƒ: $IMAGE"
            podman pull $IMAGE
            
            # æ£€æŸ¥å®¹å™¨æ˜¯å¦å­˜åœ¨
            if podman ps -a --format '{{.Names}}' | grep -q "^${CONTAINER_NAME}$"; then
              echo "ğŸ›‘ åœæ­¢å¹¶ç§»é™¤å·²å­˜åœ¨çš„å®¹å™¨: $CONTAINER_NAME"
              podman stop $CONTAINER_NAME
              podman rm $CONTAINER_NAME
            else
              echo "â„¹ï¸  å®¹å™¨ $CONTAINER_NAME ä¸å­˜åœ¨ï¼Œè·³è¿‡åœæ­¢æ­¥éª¤"
            fi
            
            # å¯åŠ¨æ–°å®¹å™¨
            echo "ğŸš€ å¯åŠ¨æ–°çš„ Deno H3 å®¹å™¨"
            podman run -d \
              --name $CONTAINER_NAME \
              -p $PORT:5010 \
              --restart=always \
              $IMAGE
            
            # éªŒè¯å®¹å™¨æ˜¯å¦æˆåŠŸè¿è¡Œ
            sleep 5
            if ! podman ps | grep -q "$CONTAINER_NAME"; then
              echo "âŒ å®¹å™¨å¯åŠ¨å¤±è´¥"
              echo "ğŸ“‹ å®¹å™¨æ—¥å¿—:"
              podman logs $CONTAINER_NAME
              exit 1
            fi
            
            # æ¸…ç†ç™»å½•å‡­è¯
            podman logout ${{ env.REGISTRY }}
            
            echo "âœ… Deno H3 åº”ç”¨éƒ¨ç½²å®Œæˆ"
            echo "ğŸŒ ç¯å¢ƒ: ${{ inputs.environment }}"
            echo "ğŸ·ï¸ é•œåƒ: $IMAGE"
            echo "ğŸš¢ å®¹å™¨: $CONTAINER_NAME"
            echo "ğŸ”Œ ç«¯å£: $PORT"
            echo "ğŸ¦• Deno H3 åº”ç”¨å·²å¯åŠ¨å¹¶è¿è¡Œ"
            
            # è¾“å‡ºå®¹å™¨çŠ¶æ€
            echo ""
            echo "ğŸ“Š å®¹å™¨çŠ¶æ€:"
            podman ps | grep $CONTAINER_NAME